<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Details | Learn with Fun!</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /*
        ============================================
        THEME & COLOR PALETTE SETUP (CSS VARIABLES)
        ============================================
        */
        :root {
            --bg-color: #0D1117;
            --primary-card-bg: rgba(22, 27, 34, 0.6);
            --secondary-card-bg: rgba(13, 17, 23, 0.7);
            --text-color: #C9D1D9;
            --heading-color: #FFFFFF;
            --accent-color-1: #58A6FF;
            --accent-color-2: #3FB950;
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --button-bg: rgba(255, 255, 255, 0.08);
            --button-text: #FFFFFF;
            --button-hover-bg: #58A6FF;
            --button-hover-text: #FFFFFF;
            --aurora-color-1: #58A6FF;
            --aurora-color-2: #A371F7;
            --aurora-color-3: #F778BA;
        }

        body[data-theme="light"] {
            --bg-color: #F4F7FC;
            --primary-card-bg: rgba(255, 255, 255, 0.6);
            --secondary-card-bg: rgba(249, 250, 255, 0.8);
            --text-color: #4A5568;
            --heading-color: #1A202C;
            --accent-color-1: #4C51BF;
            --accent-color-2: #38B2AC;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-bg: rgba(0, 0, 0, 0.05);
            --button-text: #2D3748;
            --button-hover-bg: #2D3748;
            --button-hover-text: #FFFFFF;
            --aurora-color-1: #82aaff;
            --aurora-color-2: #c792ea;
            --aurora-color-3: #ffc482;
        }

        body[data-theme="sepia"] {
            --bg-color: #FBF0D9;
            --primary-card-bg: rgba(248, 234, 214, 0.6);
            --secondary-card-bg: rgba(253, 246, 232, 0.7);
            --text-color: #5B4636;
            --heading-color: #3D2C1D;
            --accent-color-1: #8D6E63;
            --accent-color-2: #B18F6A;
            --border-color: rgba(61, 44, 29, 0.15);
            --shadow-color: rgba(91, 70, 54, 0.15);
            --button-bg: rgba(93, 64, 55, 0.08);
            --button-text: #5D4037;
            --button-hover-bg: #5D4037;
            --button-hover-text: #FFFFFF;
            --aurora-color-1: #d1a377;
            --aurora-color-2: #a87b53;
            --aurora-color-3: #c28e8e;
        }

        /*
        ============================================
        GENERAL STYLES & DYNAMIC BACKGROUND
        ============================================
        */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background-color 0.5s ease, color 0.5s ease;
            position: relative;
            overflow-x: hidden;
        }

        .background-aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .aurora-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.4;
            transition: background-color 0.5s ease;
        }

        .shape1 {
            width: 400px;
            height: 400px;
            background: var(--aurora-color-1);
            top: 10%;
            left: 10%;
            animation: move-aurora1 20s infinite alternate ease-in-out;
        }

        .shape2 {
            width: 350px;
            height: 350px;
            background: var(--aurora-color-2);
            top: 50%;
            left: 60%;
            animation: move-aurora2 25s infinite alternate ease-in-out;
        }

        .shape3 {
            width: 300px;
            height: 300px;
            background: var(--aurora-color-3);
            top: 80%;
            left: 20%;
            animation: move-aurora3 18s infinite alternate ease-in-out;
        }

        @keyframes move-aurora1 {
            from {
                transform: translate(0, 0) rotate(0deg);
            }

            to {
                transform: translate(100px, 50px) rotate(45deg);
            }
        }

        @keyframes move-aurora2 {
            from {
                transform: translate(0, 0) rotate(0deg);
            }

            to {
                transform: translate(-80px, -60px) rotate(-60deg);
            }
        }

        @keyframes move-aurora3 {
            from {
                transform: translate(0, 0) rotate(0deg);
            }

            to {
                transform: translate(60px, -100px) rotate(70deg);
            }
        }

        /*
        ============================================
        HEADER & LOGO STYLES
        ============================================
        */
        .header-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .moe-logo {
            height: 50px;
            z-index: 10;
        }

        /*
        ============================================
        THEME SWITCHER STYLES
        ============================================
        */
        .theme-switcher {
            display: flex;
            gap: 10px;
            background: var(--primary-card-bg);
            padding: 8px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow-color);
            backdrop-filter: blur(10px);
        }

        .theme-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            background-color: transparent;
            font-size: 14px;
        }

        .theme-button:hover {
            transform: scale(1.1) rotate(15deg);
            background-color: var(--button-bg);
        }

        .theme-button.active {
            border-color: var(--accent-color-1);
            color: var(--accent-color-1);
            transform: scale(1.1);
        }

        /*
        ============================================
        MAIN CONTENT & LAYOUT
        ============================================
        */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 1000px;
            animation: float-in 1.2s ease-out;
            padding-top: 100px;
        }

        @keyframes float-in {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #detail-page {
            background: var(--primary-card-bg);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 15px 50px var(--shadow-color);
            text-align: left;
            width: 100%;
            border: 1px solid var(--border-color);
            transition: all 0.5s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        h2.note-topic {
            font-weight: 700;
            font-size: 2.8rem;
            margin-bottom: 20px;
            color: var(--heading-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /*
        ============================================
        BUTTONS & INTERACTIVE ELEMENTS
        ============================================
        */
        .action-button {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            background: var(--button-bg);
            color: var(--button-text);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }

        .action-button i {
            margin-right: 10px;
            transition: transform 0.3s ease;
        }

        .action-button:hover {
            background: var(--button-hover-bg);
            color: var(--button-hover-text);
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        .action-button:hover i {
            transform: rotate(-10deg) scale(1.1);
        }

        .back-button {
            margin-bottom: 30px;
        }

        .download-button {
            margin-top: 25px;
        }

        /*
        ============================================
        NOTE CONTENT STYLES
        ============================================
        */
        #note-detail-content {
            padding: 30px;
            border-radius: 18px;
            background: var(--secondary-card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.5s ease;
        }

        .note-sub-topic {
            font-size: 1.3rem;
            color: var(--text-color);
            font-style: italic;
            opacity: 0.9;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .note-main-title {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--accent-color-2);
            margin-top: 25px;
        }

        .note-content {
            font-size: 1.1rem;
            color: var(--text-color);
            line-height: 1.9;
            margin-top: 15px;
            white-space: pre-wrap;
        }

        .note-content img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 8px 25px var(--shadow-color);
            border: 2px solid var(--border-color);
        }

        .note-content a {
            color: var(--accent-color-2);
            text-decoration: none;
            font-weight: 600;
            background: var(--button-bg);
            padding: 5px 10px;
            border-radius: 8px;
        }

        small {
            display: block;
            margin-top: 25px;
            opacity: 0.7;
        }

        /*
        ============================================
        FOOTER STYLES
        ============================================
        */
        .footer {
            width: 100%;
            max-width: 1000px;
            padding: 20px;
            background: var(--primary-card-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 20px var(--shadow-color);
            text-align: center;
            border-radius: 20px 20px 0 0;
            animation: slideUp 1s ease-in-out 0.5s backwards;
            margin-top: 40px;
            transition: all 0.5s ease;
            backdrop-filter: blur(12px);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body data-theme="dark">

    <div class="background-aurora">
        <div class="aurora-shape shape1"></div>
        <div class="aurora-shape shape2"></div>
        <div class="aurora-shape shape3"></div>
    </div>

    <header class="header-container">
        <img src="moe-logo.webp" alt="Ministry of Education Logo" class="moe-logo">
        <div class="theme-switcher">
            <button class="theme-button active" id="theme-dark" data-theme="dark" aria-label="Switch to dark theme"><i class="fas fa-moon"></i></button>
            <button class="theme-button" id="theme-light" data-theme="light" aria-label="Switch to light theme"><i class="fas fa-sun"></i></button>
            <button class="theme-button" id="theme-sepia" data-theme="sepia" aria-label="Switch to sepia theme"><i class="fas fa-book-open"></i></button>
        </div>
    </header>

    <main id="main-content">
        <section id="detail-page">
            <button class="action-button back-button" onclick="history.back()">
                <i class="fas fa-arrow-left"></i> Back to Notes
            </button>

            <div id="note-detail-area">
                <div id="note-detail-content">
                    <p>Loading note details...</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <p>&copy; Creative Learning</p>
            <p>Creative Learning is owned by Pope John</p>
        </div>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyABCpgwLNKvUxdYtnz5HBHH9IlnDZgEbUo",
            authDomain: "creative-learning-f2252.firebaseapp.com",
            projectId: "creative-learning-f2252",
            storageBucket: "creative-learning-f2252.appspot.com",
            messagingSenderId: "451756350336",
            appId: "1:451756350336:web:19b9255b8834a01f4cff65"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const {
            jsPDF
        } = window.jspdf;

        function setTheme(themeName) {
            localStorage.setItem('theme', themeName);
            document.body.setAttribute('data-theme', themeName);
            document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`theme-${themeName}`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);

            document.querySelectorAll('.theme-button').forEach(button => {
                button.addEventListener('click', () => setTheme(button.dataset.theme));
            });

            const urlParams = new URLSearchParams(window.location.search);
            const noteId = urlParams.get('noteId');
            const noteDetailArea = document.getElementById('note-detail-area');

            if (noteId) {
                loadNoteDetails(noteId, noteDetailArea);
            } else {
                noteDetailArea.innerHTML = '<div id="note-detail-content"><p>No note selected. Please go back and choose a note.</p></div>';
            }
        });

        function loadNoteDetails(noteId, detailsArea) {
            db.collection('notes').doc(noteId).get()
                .then(doc => {
                    if (doc.exists) {
                        renderNoteDetails(doc.data(), detailsArea);
                    } else {
                        detailsArea.innerHTML = '<div id="note-detail-content"><p>Note not found.</p></div>';
                    }
                })
                .catch(error => {
                    console.error("Error loading note details:", error);
                    detailsArea.innerHTML = `<div id="note-detail-content"><p>Error loading note details. Please try again later.</p></div>`;
                });
        }

        function renderNoteDetails(note, detailsArea) {
            let fileDisplay = '';
            if (note.fileUrl) {
                if (note.fileType === 'application/pdf' || note.fileUrl.endsWith('.pdf')) {
                    fileDisplay = `<p class="file-link-container"><a href="${note.fileUrl}" target="_blank" class="file-link"><i class="fas fa-file-pdf"></i> View PDF</a></p>`;
                } else if (note.fileType?.startsWith('image/')) {
                    fileDisplay = `<div><img src="${note.fileUrl}" alt="Note image" class="note-image" onclick="window.open('${note.fileUrl}', '_blank')"></div>`;
                } else {
                    fileDisplay = `<p class="file-link-container"><a href="${note.fileUrl}" target="_blank" class="file-link"><i class="fas fa-file-download"></i> Download File</a></p>`;
                }
            }

            const date = note.createdAt && typeof note.createdAt.toDate === 'function' ?
                note.createdAt.toDate().toLocaleDateString() : 'Unknown date';

            detailsArea.innerHTML = `
                <h2 class="note-topic">${escapeHTML(note.noteTopic)}</h2>
                ${note.subTopic ? `<h3 class="note-sub-topic">${escapeHTML(note.subTopic)}</h3>` : ''}
                ${note.noteTitle ? `<h4 class="note-main-title">${escapeHTML(note.noteTitle)}</h4>` : ''}
                <div id="note-detail-content">
                    <div class="note-content">${note.content}</div> ${fileDisplay}
                    <small>Posted: ${date}</small>
                    <button class="action-button download-button" onclick="downloadNote()"><i class="fas fa-download"></i> Download as PDF</button>
                </div>
            `;
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        function downloadNote() {
            try {
                const noteDetailArea = document.getElementById('note-detail-area');
                const topic = noteDetailArea.querySelector('.note-topic')?.textContent.trim() || 'Note';
                const subTopic = noteDetailArea.querySelector('.note-sub-topic')?.textContent.trim() || '';
                const noteTitle = noteDetailArea.querySelector('.note-main-title')?.textContent.trim() || '';
                const noteContentElement = noteDetailArea.querySelector('.note-content');

                const doc = new jsPDF();
                let y = 20;
                const margin = 20;
                const lineHeight = 7;
                const pageWidth = doc.internal.pageSize.getWidth() - (margin * 2);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text(topic, margin, y);
                y += lineHeight * 1.5;

                if (subTopic) {
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(12);
                    doc.text(`Subtopic: ${subTopic}`, margin, y);
                    y += lineHeight * 1.5;
                }

                if (noteTitle) {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text(`Title: ${noteTitle}`, margin, y);
                    y += lineHeight * 2;
                }

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);

                let contentText = noteContentElement.innerText || noteContentElement.textContent;
                let lines = doc.splitTextToSize(contentText, pageWidth);
                lines.forEach(line => {
                    if (y > doc.internal.pageSize.getHeight() - 20) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, margin, y);
                    y += lineHeight;
                });

                const fileName = `Note_${topic.replace(/\s/g, '_')}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error("PDF generation failed:", error);
            }
        }
    </script>
</body>

</html>
